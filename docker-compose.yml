version: "3.9"

services:
  postgres:
    image: postgres:15-alpine
    container_name: fivebyfive-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fivebyfive}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fivebyfive}
      POSTGRES_DB: ${POSTGRES_DB:-fivebyfive}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: fivebyfive-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redisdata:/data

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: fivebyfive-keycloak
    command: ["start-dev", "--http-port=8080"]
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
    ports:
      - "${KEYCLOAK_HTTP_PORT:-8080}:8080"
    depends_on:
      - postgres

  coturn:
    image: coturn/coturn:latest
    container_name: fivebyfive-coturn
    ports:
      - "${TURN_PORT:-3478}:3478/udp"
      - "${TURN_PORT:-3478}:3478/tcp"
      - "${TURN_MIN_PORT:-49160}-${TURN_MAX_PORT:-49200}:${TURN_MIN_PORT:-49160}-${TURN_MAX_PORT:-49200}/udp"
    command:
      - -n
      - --realm=${TURN_REALM:-5x5.local}
      - --listening-port=${TURN_PORT:-3478}
      - --tls-listening-port=5349
      - --min-port=${TURN_MIN_PORT:-49160}
      - --max-port=${TURN_MAX_PORT:-49200}
      - --use-auth-secret
      - --static-auth-secret=${TURN_SHARED_SECRET:-changeme}
      - --no-stdout-log
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:latest
    container_name: fivebyfive-livekit
    command: ["--config", "/livekit/livekit.yaml"]
    volumes:
      - ./infra/livekit/livekit.yaml:/livekit/livekit.yaml:ro
    ports:
      - "${LIVEKIT_HTTP_PORT:-7880}:7880"
      - "${LIVEKIT_WS_PORT:-7881}:7881"
      - "${LIVEKIT_RTC_UDP_PORT:-7882}:7882/udp"
      - "${LIVEKIT_RTC_TCP_PORT:-7883}:7883"
    depends_on:
      - redis
      - coturn

  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: fivebyfive-api
    environment:
      NODE_ENV: development
      PORT: 4000
      DATABASE_URL: postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB
      REDIS_URL: redis://redis:6379
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-fivebyfive}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-fivebyfive-api}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-changeme}
      LIVEKIT_URL: http://livekit:7880
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY:-devkey}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET:-devsecretdevsecretdevsecretdevsecret}
      TURN_DOMAIN: ${TURN_DOMAIN:-localhost}
      TURN_SHARED_SECRET: ${TURN_SHARED_SECRET:-changeme}
    ports:
      - "${API_PORT:-4000}:4000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      livekit:
        condition: service_started

  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: fivebyfive-web
    environment:
      VITE_API_URL: http://localhost:${API_PORT:-4000}
    ports:
      - "${WEB_PORT:-5173}:5173"
    depends_on:
      - api

volumes:
  pgdata:
  redisdata:


